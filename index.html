!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editable Quotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FONT FOR SCREEN + PRINT -->
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

<style>
    @media print {
      @page {
        margin: 0.5in;
      }

      body {
        margin: 0 !important;
        padding: 0 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        font-family: 'Roboto', sans-serif;
        font-size: 12px;
        line-height: 1.5;
      }

      body * {
        visibility: hidden;
      }

      #quotation-wrapper,
      #quotation-wrapper * {
        visibility: visible;
      }

      #quotation-wrapper {
        width: 900px !important;
        max-width: 900px !important;
        margin: 0 auto !important;
        padding: 0 !important;
        position: relative;
      }

      .max-w-6xl,
      .max-w-5xl,
      .p-6,
      .px-10 {
        max-width: 100% !important;
        padding: 0 !important;
      }

      .right-info-box {
        float: none !important;
        display: inline-block !important;
        vertical-align: top;
        margin-left: 0 !important;
        width: 260px !important;
        font-size: 10px !important;
        box-sizing: border-box;
        color-adjust: exact;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        border: 1px solid #1f2937 !important;
      }

      .right-info-box .header {
        background-color: #374151 !important;
        color: white !important;
        border-top: 1px solid #d1d5db !important;
        border-bottom: 1px solid #d1d5db !important;
      }

      .right-info-box .section {
        padding: 4px 8px;
        border-bottom: 1px solid #d1d5db !important;
      }

      #quotation-info {
        width: 400px !important;
        max-width: 400px !important;
        margin-bottom: 16px;
      }

      .requirement-table,
      .note-table,
      .editable-table,
      .right-info-box,
      .cost-summary-table {
        page-break-inside: avoid;
      }

      .cost-summary {
        page-break-before: always;
      }

      .section-title-print {
        font-size: 14px !important;
        font-weight: 600 !important;
        border-bottom: 1px solid #999 !important;
        margin-top: 20px !important;
        margin-bottom: 8px !important;
      }

      .add-table-button {
        margin-top: 10px;
        margin-bottom: 20px;
      }

      .notes-section table td {
        white-space: pre-wrap;
      }

      button,
      input[type="file"],
      .no-print {
        display: none !important;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 12px;
      }

      table th,
      table td {
        border: 1px solid #d1d5db;
        padding: 6px 10px;
        vertical-align: top;
        text-align: left;
        word-break: break-word;
      }

      table th {
        background-color: #f3f4f6;
        font-weight: 600;
      }

      .editable-table-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 6px;
      }

      .tables-container,
      .notes-section,
      .cost-summary {
        width: 900px;
        margin: 0 auto;
      }
      th.resizable {
        position: relative;
      }
      th.resizable .resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 5px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
      }
      input, textarea {
        background: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    color: black !important;
    font-family: inherit !important;
    font-size: inherit !important;
    line-height: auto !important;
  }
          }
  </style>

</head>
<body class="bg-gray-100 text-sm text-gray-800 font-sans">
<div id="quotation-wrapper" class="bg-white p-6  max-w-screen-lg mx-auto ">
  <div class="max-w-6xl mx-auto p-6 bg-white">
<div class="bg-white py-4 mb-4">
  <div class="max-w-5xl mx-auto px-10 flex justify-center">
    <img src="images/header.png" alt="Company Header" class="w-full max-h-40 object-contain" />
  </div>
</div>
  <!-- Header -->
  <div class="flex justify-between items-start">
    <div>
      <div class="flex items-start mb-4">
  <label class="w-24 font-bold pt-1">Date:</label>
  <input 
    type="date" 
    value="2025-04-21"
    class="border-b border-gray-400 focus:outline-none text-center w-48"
  />
</div>

      <br/>
      <!-- Client Address and Att'n Section -->
<!-- Client -->
<div class="flex items-start mb-4">
  <label class="w-24 font-bold pt-1">Client:</label>
  <div class="flex flex-col space-y-1">
    <textarea
      rows="1"
      placeholder="Enter Client or Company Name"
      class="w-80 resize-none overflow-hidden ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none
             print:ring-0 print:border-none print:outline-none print:shadow-none"
      oninput="autoExpandTextarea(this)"
    ></textarea>
    <textarea
      rows="1"
      placeholder="Enter Address"
      class="w-80 resize-none overflow-hidden ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none
             print:ring-0 print:border-none print:outline-none print:shadow-none"
      oninput="autoExpandTextarea(this)"
    ></textarea>
  </div>
</div>

<!-- Attention -->
<div class="flex items-start mb-4">
  <label class="w-24 font-bold pt-1">Att'n:</label>
  <div class="flex flex-col space-y-1">
    <textarea
      rows="1"
      placeholder="Enter Name"
      class="w-80 resize-none overflow-hidden ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none
             print:ring-0 print:border-none print:outline-none print:shadow-none"
      oninput="autoExpandTextarea(this)"
    ></textarea>
    <textarea
      rows="1"
      placeholder="Enter Position"
      class="w-80 resize-none overflow-hidden ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none
             print:ring-0 print:border-none print:outline-none print:shadow-none"
      oninput="autoExpandTextarea(this)"
    ></textarea>
  </div>
</div>

      <br/>
<!-- Subject moved closer to greeting -->
<!-- Subject -->
<div class="flex items-start mt-6">
  <label class="w-24 font-bold pt-1">Subject:</label>
  <textarea
    rows="1"
    placeholder="Enter subject"
    class="w-[500px] resize-none overflow-hidden ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none
           print:ring-0 print:border-none print:outline-none print:shadow-none"
    oninput="autoExpandTextarea(this)"
  ></textarea>
</div>


    </div>

    <!-- Right Info Box -->
<body class="bg-gray-100 text-sm">
  <div class="flex items-start">
    <div class="right-info-box w-[320px] border border-gray-700 text-xs print:w-[320px] print:border print:border-gray-700 print:text-[10px] print:box-border">
      <!-- Top Tagline -->
      <div class="text-center font-semibold py-2 text-lg print:text-base print:py-1">
        Efficiency Matters!
      </div>

      <!-- Header -->
      <div class="bg-gray-700 px-3 py-2 font-bold text-white text-center border-t border-b border-gray-300 print:bg-gray-700 print:text-white print:border-t print:border-b print:border-gray-300">
        QUOTATION
      </div>

      <!-- Info Rows -->
      <div class="px-3 py-1 border-b border-gray-300 print:border-b print:border-gray-300">
        <strong>Quotation Ref.:</strong><br/>
        <span contenteditable="true">VFI-2025-0102-0-R5</span>
      </div>

      <div class="px-3 py-1 border-b border-gray-300 print:border-b print:border-gray-300">
        <strong>Client P.R No.:</strong><br/>
        <span contenteditable="true">Direct</span>
      </div>

      <div class="px-3 py-1 border-b border-gray-300 print:border-b print:border-gray-300">
        <strong>Prepared by:</strong><br/>
        <span contenteditable="true">FEC</span>
      </div>

      <div class="px-3 py-1 border-b border-gray-300 print:border-b print:border-gray-300">
        <strong>Email:</strong><br/>
        <span contenteditable="true">fecient@gmail.com</span>
      </div>

      <div class="px-3 py-1 print:border-0">
        <strong>Page(s):</strong><br/>
        <span contenteditable="true">4</span>
      </div>
    </div>


  </div>
  </div>

<!-- Greeting Message -->
    <div id="greeting-message" class="mb-6">
  <div id="greeting-text" contenteditable="true" class="whitespace-pre-line">
    Hello Sir/Ma'am,

    We are pleased to submit our best offer for the following:
  </div>
</div>

    <!-- Table Template (Hidden) -->
    <div id="table-template" class="hidden">
      <div class="requirement-table border border-none 0 rounded-md overflow-hidden relative">
        <div contenteditable="true" class="bg-gray-700 text-white px-4 py-2 font-semibold">
          I. GENERAL REQUIREMENTS
        </div>
        <table class="w-full text-sm">
          <thead class="bg-gray-none text-gray-800 border-b border-gray-none">
            <tr>
              <th class="resizable text-left px-4 py-2 w-12">
                No.
                <div class="resizer"></div>
              </th>
              <th class="resizable text-left px-4 py-2">
                Description
                <div class="resizer"></div>
              </th>
              <th class="resizable text-center px-4 py-2 w-24">
                Qty
                <div class="resizer"></div>
              </th>
              <th class="resizable text-center px-4 py-2 w-32">
                Amount (â‚±)
                <div class="resizer"></div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-none">
              <td class="px-4 py-2 align-top">1.</td>
              <td class="px-4 py-2">
                <textarea placeholder="Enter Description" class="w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none resize-y auto-expand" rows="1" oninput="autoExpandTextarea(this)"></textarea>
              </td>
              <td class="text-right px-4 py-2 align-top">
                <input value="1 Lot" class="text-center w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none" />
              </td>
              <td class="text-right px-4 py-2 align-top">
                <input value="210000.00" placeholder="Enter Amount" class="text-center w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none" />
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="bg-gray-none">
              <td colspan="3" class="text-right font-bold px-4 py-2">TOTAL</td>
              <td class="text-right px-4 py-2 font-bold total-cost">â‚± 0.00</td>
            </tr>
          </tfoot>
        </table>

        <div class="flex justify-end gap-2 px-4 py-2 print:hidden">
          <button onclick="addRow(this)" class="bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700">+ Add Row</button>
          <button onclick="deleteRow(this)" class="bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">âˆ’ Delete Row</button>
        </div>
        <button onclick="deleteTable(this)" class="print:hidden absolute top-2 right-2 text-xs text-white font-semibold bg-red-600 rounded hover:bg-red-800">Delete Table</button>
      </div>
    </div>

    <!-- Main Container for Tables -->
    <div id="tables-container" class="space-y-6 mt-4 w-[900px] mx-auto">
      <!-- Initial Table -->
      <div class="requirement-table border border-none 0 rounded-md overflow-hidden relative">
        <div contenteditable="true" class="bg-gray-700 text-white px-4 py-2 font-semibold">
          I. GENERAL REQUIREMENTS
        </div>
        <table class="w-full text-sm">
          <thead class="bg-gray-none text-gray-800 border-b border-gray-none">
            <tr>
              <th class="resizable text-left px-4 py-2 w-12">
                No.
                <div class="resizer"></div>
              </th>
              <th class="resizable text-left px-4 py-2">
                Description
                <div class="resizer"></div>
              </th>
              <th class="resizable text-center px-4 py-2 w-24">
                Qty
                <div class="resizer"></div>
              </th>
              <th class="resizable text-center px-4 py-2 w-32">
                Amount (â‚±)
                <div class="resizer"></div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-none">
              <td class="px-4 py-2 align-top">1.</td>
              <td class="px-4 py-2">
                <textarea placeholder="Enter Description" class="w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none resize-y auto-expand" rows="1" oninput="autoExpandTextarea(this)"></textarea>
              </td>
              <td class="text-right px-4 py-2 align-top">
                <input value="" placeholder="Enter Qty" class="text-center w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none" />
              </td>
              <td class="text-right px-4 py-2 align-top">
                <input value="" placeholder="Enter Amount" class="text-center w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none" />
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="bg-gray-none">
              <td colspan="3" class="text-right font-bold px-4 py-2">TOTAL</td>
              <td class="text-right px-4 py-2 font-bold total-cost">â‚± 0.00</td>
            </tr>
          </tfoot>
        </table>
        <div class="flex justify-end gap-2 px-4 py-2 print:hidden">
          <button onclick="addRow(this)" class="bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700">+ Add Row</button>
          <button onclick="deleteRow(this)" class="bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">âˆ’ Delete Row</button>
        </div>
        <button onclick="deleteTable(this)" class="print:hidden absolute top-2 right-2 text-xs text-white font-semibold bg-red-600 rounded hover:bg-red-800">Delete Table</button>
      </div>
    </div> 
  </div> 
  <!-- Cost Summary Table -->
<div class="mt-8 border border-black rounded-md w-[900px] mx-auto text-sm">
  <div class="bg-gray-700 text-white px-4 py-1 font-semibold uppercase">COST SUMMARY</div>
  <table class="w-full text-sm border-t border-black">
    <thead class="bg-white text-black border-b border-black">
      <tr class="text-left">
        <th class="px-4 py-2 w-2/3">Section</th>
        <th class="px-4 py-2 text-right w-1/3">Subtotal (â‚±)</th>
      </tr>
    </thead>
    <tbody id="summary-body" class="text-black"></tbody>
    <tfoot class="text-black font-semibold">
      <tr class="border-t border-black">
        <td class="px-4 py-2 text-right">TOTAL AMOUNT (VAT EX):</td>
        <td class="px-4 py-2 text-right" id="total-vat-ex">â‚± 0.00</td>
      </tr>
      <tr class="text-red-600 font-bold border-t border-black">
        <td class="px-4 py-2 text-right">LESS DISCOUNT :</td>
        <td class="px-4 py-2 text-right">
          <input id="discount-input" type="text" class="w-full text-right focus:outline-none" placeholder="Enter Discount value"/>
        </td>
      </tr>
      <tr class="border-t border-black">
        <td class="px-4 py-2 text-right">VAT 12%:
          <select id="vat-mode" onchange="recalculateTotals()" class="ml-2 border border-gray-400 px-1 py-0.5 rounded print:hidden">
            <option value="ex">VAT Exclusive</option>
            <option value="in">VAT Inclusive</option>
          </select>
        </td>
        <td class="px-4 py-2 text-right">
          <input id="vat-input" type="text" class="w-full text-right focus:outline-none" placeholder="-"/>
        </td>
      </tr>
      <tr class="bg-yellow-400 border-t-4 border-black text-black font-extrabold text-base">
        <td class="px-4 py-2 text-right" id="grand-total-label">TOTAL AMOUNT VAT EX :</td>
        <td class="px-4 py-2 text-right" id="grand-total">â‚± 0.00</td>
      </tr>
    </tfoot>
  </table>
</div>
  <div class="mt-4 flex gap-2">
    <button onclick="addTable()"
            class="print:hidden px-4 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
      + Add Table
    </button>
  </div>
<div id="notes-section">
    <div class="requirement-table border border-none mt-4 rounded-md overflow-hidden relative w-[900px] mx-auto" data-default="true">
      <div contenteditable="true" class="bg-gray-700 text-white px-4 py-2 font-semibold">
        Additional Notes
      </div>
      <table class="w-full text-sm">
        <thead class="bg-gray-100 text-gray-800 border-b border-gray-300 hidden">
          <tr>
            <th class="hidden">No.</th>
            <th class="text-left px-4 py-2">Description</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-none">
            <td class="hidden">1.0</td>
            <td class="px-4 py-0">
              <textarea
                class="w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none resize-y overflow-hidden auto-expand"
                rows="1" oninput="autoExpandTextarea(this)"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="flex justify-end gap-2 px-4 py-2 print:hidden">
        <button onclick="addRow(this)" class="bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700">+ Add Row</button>
        <button onclick="deleteRow(this)" class="bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">âˆ’ Delete Row</button>
      </div>
      <button onclick="deleteNoteTable(this)"
              class="print:hidden absolute top-2 right-2 text-xs text-white font-semibold bg-red-600 rounded hover:bg-red-800">
        Delete Table
      </button>
    </div>
  </div>

  <div class="mt-4 flex gap-2">
    <button onclick="addNoteTable()" class="print:hidden px-4 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
      + Add Table
    </button>
  </div>
<div class="mt-4 flex gap-2">
  <button onclick="saveFormData()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded">
    ðŸ’¾ Save
  </button>
  <label class="print:hidden px-4 py-1 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700 cursor-pointer">
    ðŸ“‚ Load
    <input type="file" accept=".json" onchange="loadFormData(event)" class="hidden">
  </label>
</div>
<script>
function autoExpandTextarea(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

function addRow(button) {
  const tbody = button.closest('.requirement-table').querySelector('tbody');
  const rows = tbody.querySelectorAll('tr');
  if (!rows.length) return;

  const newRow = rows[0].cloneNode(true);
  newRow.querySelectorAll('input, textarea').forEach(field => {
    field.value = '';
    if (field.tagName.toLowerCase() === 'textarea') {
      field.removeAttribute('disabled');
      field.setAttribute('oninput', 'autoExpandTextarea(this)');
      field.rows = 1;
      autoExpandTextarea(field);
    }
  });
  newRow.querySelector('td').classList.remove('py-2');
  newRow.querySelector('td').classList.add('py-0');
  tbody.appendChild(newRow);
  setTimeout(() => autoExpandTextarea(newRow.querySelector('textarea')), 0);
}

function deleteRow(button) {
  const tbody = button.closest('.requirement-table').querySelector('tbody');
  const rows = tbody.querySelectorAll('tr');
  if (rows.length > 1) {
    rows[rows.length - 1].remove();
  } else {
    alert("At least one row is required.");
  }
}

function deleteNoteTable(button) {
  const notesSection = document.getElementById('notes-section');
  const tables = notesSection.querySelectorAll('.requirement-table');
  if (tables.length > 1) {
    button.closest('.requirement-table').remove();
  } else {
    alert("You must keep at least one Notes table.");
  }
}

function addNoteTable() {
  const notesSection = document.getElementById('notes-section');
  const original = notesSection.querySelector('.requirement-table');
  const clone = original.cloneNode(true);

  clone.removeAttribute('data-default');

  const tbody = clone.querySelector('tbody');
  tbody.innerHTML = '';

  const newRow = document.createElement('tr');
  newRow.className = 'border-none';
  newRow.innerHTML = `
    <td class="hidden">1.0</td>
    <td class="px-4 py-0">
      <textarea
        class="w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none resize-y overflow-hidden auto-expand"
        rows="1" oninput="autoExpandTextarea(this)"></textarea>
    </td>
  `;
  tbody.appendChild(newRow);

  notesSection.appendChild(clone);
  setTimeout(() => autoExpandTextarea(tbody.querySelector('textarea')), 0);
}
</script>
<script>
function recalculateTotals() {
  let grandTotal = 0;
  const summaryBody = document.getElementById('summary-body');
  if (summaryBody) summaryBody.innerHTML = '';

  document.querySelectorAll('#tables-container .requirement-table').forEach(table => {
    let tableTotal = 0;
    table.querySelectorAll('tbody tr').forEach(row => {
      const inputs = row.querySelectorAll('input');
      const amountInput = inputs[inputs.length - 1];
      if (amountInput) {
        const value = parseFloat(amountInput.value.replace(/,/g, ''));
        if (!isNaN(value)) tableTotal += value;
      }
    });

    const totalCell = table.querySelector('.total-cost');
    if (totalCell) {
      totalCell.textContent = 'â‚± ' + tableTotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
    }

    const title = table.querySelector('div[contenteditable="true"]')?.textContent.trim() || 'Untitled Section';
    if (summaryBody) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2">${title}</td>
        <td class="text-right px-4 py-2">â‚± ${tableTotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
      `;
      summaryBody.appendChild(tr);
    }

    grandTotal += tableTotal;
  });

  const discount = parseFloat((document.getElementById('discount-input')?.value || '0').replace(/,/g, '')) || 0;
  const vatMode = document.getElementById('vat-mode')?.value;
  const labelCell = document.getElementById('grand-total-label');

  const net = grandTotal - discount;
  let vatAmount = 0;
  let finalTotal = 0;

  const vatInput = document.getElementById('vat-input');

  if (vatMode === 'in') {
    vatAmount = net * 0.12;
    finalTotal = net + vatAmount;
    if (labelCell) labelCell.textContent = 'TOTAL AMOUNT VAT INC :';
    if (vatInput) vatInput.value = vatAmount.toLocaleString(undefined, { minimumFractionDigits: 2 });
  } else {
    vatAmount = 0;
    finalTotal = net;
    if (labelCell) labelCell.textContent = 'TOTAL AMOUNT VAT EX :';
    if (vatInput) vatInput.value = ''; // Clear VAT display
  }

  const totalVatEx = document.getElementById('total-vat-ex');
  if (totalVatEx) totalVatEx.textContent = 'â‚± ' + net.toLocaleString(undefined, { minimumFractionDigits: 2 });

  const grandTotalEl = document.getElementById('grand-total');
  if (grandTotalEl) grandTotalEl.textContent = 'â‚± ' + finalTotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
}
 function updateRowNumbers(tbody) {
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, i) => {
      const cell = row.querySelector('td');
      if (cell) cell.textContent = (i + 1) + '.0';
    });
  }

function addRow(button) {
  const tbody = button.closest('.requirement-table').querySelector('tbody');
  const rows = tbody.querySelectorAll('tr');
  if (!rows.length) return;

  const newRow = rows[0].cloneNode(true);

  // Clear all input and textarea values
  newRow.querySelectorAll('input, textarea').forEach(field => field.value = '');

  tbody.appendChild(newRow);
  updateRowNumbers(tbody);
  attachInputListeners(tbody);
  recalculateTotals();
}


  function deleteRow(button) {
    const tbody = button.closest('.requirement-table').querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    if (rows.length > 1) {
      rows[rows.length - 1].remove();
      updateRowNumbers(tbody);
      recalculateTotals();
    } else {
      alert("At least one row is required.");
    }
  }

  function toRoman(num) {
    const romanMap = [
      ['M', 1000], ['CM', 900], ['D', 500], ['CD', 400],
      ['C', 100], ['XC', 90], ['L', 50], ['XL', 40],
      ['X', 10], ['IX', 9], ['V', 5], ['IV', 4], ['I', 1]
    ];
    let result = '';
    for (const [roman, value] of romanMap) {
      while (num >= value) {
        result += roman;
        num -= value;
      }
    }
    return result;
  }

function addTable() {
  const container = document.getElementById('tables-container');
  const firstTable = container.querySelector('.requirement-table');
  const newTable = firstTable.cloneNode(true);

  const tableCount = container.querySelectorAll('.requirement-table').length;
  const romanLabel = toRoman(tableCount + 1);
  const titleDiv = newTable.querySelector('div[contenteditable="true"]');
  titleDiv.textContent = `${romanLabel}. ENTER TITLE HERE`;

  const tbody = newTable.querySelector('tbody');
  const firstRow = tbody.querySelector('tr');
  tbody.innerHTML = '';

  const newRow = firstRow.cloneNode(true);
  newRow.querySelectorAll('input, textarea').forEach(field => field.value = '');
  tbody.appendChild(newRow);

  updateRowNumbers(tbody);
  newTable.querySelector('.total-cost').textContent = 'â‚± 0.00';

  container.appendChild(newTable);

  // ðŸŸ¢ Required for new table: resizable columns
  makeColumnsResizable(newTable.querySelector('table'));

  attachInputListeners(newTable);
  attachTitleListeners();
  recalculateTotals();
}

  function deleteTable(button) {
    const container = document.getElementById('tables-container');
    if (container.querySelectorAll('.requirement-table').length > 1) {
      button.closest('.requirement-table').remove();
      recalculateTotals();
    } else {
      alert("You must keep at least one table.");
    }
  }

  function attachInputListeners(scope = document) {
    scope.querySelectorAll('input').forEach(input => {
      input.removeEventListener('input', recalculateTotals);
      input.addEventListener('input', recalculateTotals);
    });
  }
  function attachTitleListeners(scope = document) {
  scope.querySelectorAll('#tables-container .requirement-table div[contenteditable="true"]').forEach(titleDiv => {
    titleDiv.removeEventListener('input', recalculateTotals);
    titleDiv.addEventListener('input', recalculateTotals);
  });
  }

  window.addEventListener('load', () => {
    attachInputListeners();
    attachTitleListeners(); // âœ… Initial load title edit detection
    recalculateTotals();
    // Add a second note table by default on page load
  addNoteTable();
  });
  
</script>
<script>
      function saveFormData() {
  const formState = {
    date: document.querySelector('input[type="date"]')?.value || '',
    client: Array.from(document.querySelectorAll('[placeholder="Enter Client or Company Name"], [placeholder="Enter Address"]')).map(t => t.value),
    attention: Array.from(document.querySelectorAll('[placeholder="Enter Name"], [placeholder="Enter Position"]')).map(t => t.value),
    subject: document.querySelector('[placeholder="Enter subject"]')?.value || '',
    headerFields: Array.from(document.querySelectorAll('.border-gray-700 span[contenteditable="true"]')).map(el => el.textContent.trim()),
    greeting: document.querySelector('#greeting-message [contenteditable]')?.innerText.trim() || '',
    tables: [],
    notes: [],
    discount: document.getElementById('discount-input')?.value || '',
    vatMode: document.getElementById('vat-mode')?.value || '',
    vatInput: document.getElementById('vat-input')?.value || ''
  };

  document.querySelectorAll('#tables-container .requirement-table').forEach(table => {
    const sectionTitle = table.querySelector('div[contenteditable="true"]')?.textContent.trim() || '';
    
    // âœ… Get column widths
    const colWidths = Array.from(table.querySelectorAll('th')).map(th => th.offsetWidth);

    const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
      const tds = tr.querySelectorAll('td');
      const inputs = tr.querySelectorAll('input, textarea');
      return {
        no: tds[0]?.textContent.trim() || '',
        description: inputs[0]?.value || '',
        qty: inputs[1]?.value || '',
        amount: inputs[2]?.value || ''
      };
    });

    formState.tables.push({ sectionTitle, rows, colWidths });
  });

  document.querySelectorAll('#notes-section .requirement-table').forEach(noteTable => {
    const sectionTitle = noteTable.querySelector('div[contenteditable="true"]')?.textContent.trim() || 'Additional Notes';
    const notes = Array.from(noteTable.querySelectorAll('textarea')).map(t => t.value);
    formState.notes.push({ sectionTitle, notes });
  });

  const blob = new Blob([JSON.stringify(formState, null, 2)], { type: 'application/json' });

  const defaultName = 'quotation-data.json';
  window.temporaryBlob = blob; // Store it temporarily until user enters file name
  openSaveModal();
}


      function loadFormData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            const originalNote = document.querySelector('.requirement-table[data-default="true"]');

            document.querySelector('input[type="date"]').value = data.date || '';
            const clientTextareas = document.querySelectorAll('[placeholder="Enter Client or Company Name"], [placeholder="Enter Address"]');
            clientTextareas.forEach((ta, i) => ta.value = data.client?.[i] || '');

            const attnTextareas = document.querySelectorAll('[placeholder="Enter Name"], [placeholder="Enter Position"]');
            attnTextareas.forEach((ta, i) => ta.value = data.attention?.[i] || '');

            document.querySelector('[placeholder="Enter subject"]').value = data.subject || '';
            document.querySelectorAll('.border-gray-700 span[contenteditable="true"]').forEach((el, i) => {
              el.textContent = data.headerFields?.[i] || '';
            });

            const greeting = document.querySelector('#greeting-message [contenteditable]');
if (greeting && data.greeting) greeting.innerText = data.greeting;


            document.getElementById('discount-input').value = data.discount || '';
            document.getElementById('vat-mode').value = data.vatMode || '';
            document.getElementById('vat-input').value = data.vatInput || '';

            const tableContainer = document.getElementById('tables-container');
            tableContainer.innerHTML = '';

            data.tables.forEach(tbl => {
              const tableTemplate = document.querySelector('.requirement-table').cloneNode(true);
              tableTemplate.querySelector('div[contenteditable="true"]').textContent = tbl.sectionTitle;
              const tbody = tableTemplate.querySelector('tbody');
              tbody.innerHTML = '';
              tbl.rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-none';
                tr.innerHTML = `
                  <td class="px-4 py-2 align-top">${row.no}</td>
                  <td class="px-4 py-2">
                    <textarea class="w-full ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none resize-y auto-expand"
                      rows="1" oninput="autoExpandTextarea(this)">${row.description}</textarea>
                  </td>
                  <td class="text-right px-4 py-2 align-top">
                    <input class="text-center w-full ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none" value="${row.qty}">
                  </td>
                  <td class="text-right px-4 py-2 align-top">
                    <input class="text-center w-full ring-2 ring-blue-300 focus:ring-blue-500 rounded focus:outline-none" value="${row.amount}">
                  </td>
                `;
                tbody.appendChild(tr);
              });
               // âœ… Apply saved column widths here
  if (tbl.colWidths && Array.isArray(tbl.colWidths)) {
    const ths = tableTemplate.querySelectorAll('th');
    tbl.colWidths.forEach((width, i) => {
      if (ths[i]) {
        ths[i].style.width = width + 'px';
      }
    });
  }
              tableContainer.appendChild(tableTemplate);
            });

            const notesSection = document.getElementById('notes-section');

// Remove only existing note tables (divs with .requirement-table)
                const tables = notesSection.querySelectorAll('.requirement-table');
                tables.forEach(tbl => tbl.remove());

            data.notes.forEach(noteGroup => {
  const noteClone = originalNote.cloneNode(true);
  const titleDiv = noteClone.querySelector('div[contenteditable="true"]');
  if (titleDiv) titleDiv.textContent = noteGroup.sectionTitle || 'Additional Notes';

  const tbody = noteClone.querySelector('tbody');
  tbody.innerHTML = '';
  noteGroup.notes.forEach(note => {
    const tr = document.createElement('tr');
    tr.className = 'border-none';
    tr.innerHTML = `
      <td class="hidden">1.0</td>
      <td class="px-4 py-0">
        <textarea class="w-full ring-2 ring-blue-300 focus:ring-2 focus:ring-blue-500 rounded focus:outline-none print:ring-0 print:outline-none resize-y overflow-hidden auto-expand"
          rows="1" oninput="autoExpandTextarea(this)">${note}</textarea>
      </td>
    `;
    tbody.appendChild(tr);
  });

  notesSection.appendChild(noteClone);
});


            attachInputListeners();
            recalculateTotals();
            attachTitleListeners(); // ðŸ” Reconnect section title edits
            // âœ… Auto-resize all textareas after loading JSON
setTimeout(() => {
  document.querySelectorAll("textarea").forEach((textarea) => {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
  });
}, 0);
// âœ… Remove any existing resizers first
document.querySelectorAll('.column-resizer').forEach(resizer => resizer.remove());

// âœ… Reattach column resizers to restored tables
document.querySelectorAll('.requirement-table table').forEach(table => {
  makeColumnsResizable(table);
});

          } catch (err) {
            alert("Invalid JSON file.");
            console.error(err);
          }
        };
        reader.readAsText(file);
      }
      function openSaveModal() {
  document.getElementById("fileNameInput").value = "";
  document.getElementById("saveModal").classList.remove("hidden");
}

function closeSaveModal() {
  document.getElementById("saveModal").classList.add("hidden");
}

function confirmSave() {
  const fileName = document.getElementById("fileNameInput").value.trim();
  if (!fileName || !window.temporaryBlob) return;

  closeSaveModal();
  performSave(fileName);
}

async function performSave(fileName) {
  try {
    const options = {
      suggestedName: fileName.endsWith('.json') ? fileName : fileName + '.json',
      types: [{
        description: 'JSON Files',
        accept: { 'application/json': ['.json'] }
      }]
    };

    const handle = await window.showSaveFilePicker(options);
    const writable = await handle.createWritable();
    await writable.write(window.temporaryBlob);
    await writable.close();

    alert('File saved successfully!');
    window.temporaryBlob = null;
  } catch (err) {
    console.error('Save cancelled or failed:', err);
  }
}


    </script>
  </div>
  <div id="saveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md space-y-4">
    <h2 class="text-lg font-bold text-gray-700">Save Quotation</h2>
    <input type="text" id="fileNameInput" placeholder="Enter file name..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-500" />
    <div class="flex justify-end gap-2">
      <button onclick="closeSaveModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
      <button onclick="confirmSave()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
    </div>
  </div>
</div>
</div> <!-- End of #quotation-wrapper -->
<script>
function makeColumnsResizable(table) {
  table.querySelectorAll('.column-resizer').forEach(resizer => resizer.remove());

  const headerRow = table.querySelector('thead tr') || table.rows[0];
  if (!headerRow) return;

  const cols = headerRow.children;

  for (let i = 0; i < cols.length; i++) {
    const col = cols[i];
    col.style.position = 'relative';

    const resizer = document.createElement('div');
    resizer.className = 'column-resizer';
    resizer.style.width = '5px';
    resizer.style.height = '100%';
    resizer.style.position = 'absolute';
    resizer.style.right = '0';
    resizer.style.top = '0';
    resizer.style.cursor = 'col-resize';
    resizer.style.userSelect = 'none';
    resizer.style.zIndex = '10';

    resizer.addEventListener('mousedown', initResize);

    col.appendChild(resizer);

    function initResize(e) {
      e.preventDefault();
      const startX = e.pageX;
      const startWidth = col.offsetWidth;

      function doResize(e) {
        const newWidth = startWidth + (e.pageX - startX);
        col.style.width = newWidth + 'px';
      }

      function stopResize() {
        window.removeEventListener('mousemove', doResize);
        window.removeEventListener('mouseup', stopResize);
      }

      window.addEventListener('mousemove', doResize);
      window.addEventListener('mouseup', stopResize);
    }
  }
}

// ðŸŸ¢ Apply on load to all existing tables
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.requirement-table table').forEach(makeColumnsResizable);
});
</script>

</body>
</html>
